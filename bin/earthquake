#!/usr/bin/env ruby
gem 'slop', '~> 2.0'
require 'slop'
require 'stringio'

argv = ARGV.dup
io = StringIO.new
slop = Slop.new(:strict => true, :help => true, :exit_on_help => false, :io => io)
slop.banner "Usage: earthquake [options] [directory]"
slop.on :d, :debug, 'Enable debug mode'
slop.on :l, :logo, 'Show Logo', default: true
slop.on :n, 'No Logo (deprecated)'
slop.on :c, :command=, "Invoke a command and exit"
slop.on :stream, "Stream mode", default: true
begin
  slop.parse!(argv)
  (help = io.string).each_line do |line|
    if m = /\A.{8}--(\S+ {5})/.match(line)
      name = m[1].rstrip
      if name != "help" and !slop.options[name.to_sym].expects_argument?
        puts line.sub(m[1], "[no-]" + name)
        next
      end
    end
    puts line
  end
  exit unless help.empty?
rescue => e
  puts e
  exit!
end
options = slop.to_hash
if options.delete(:n)
  warn "-n is deprecated. use --no-logo instead."
  options.delete(:logo)
end
options.delete(:help)
options[:dir] = argv.shift unless argv.empty?

require 'pathname'
$:.unshift Pathname.new(__FILE__).realpath.join('../../lib') if $0 == __FILE__
require "earthquake/version"

command = options.delete(:command)
logo = options.delete(:logo)

if logo && !command
  print "\e[31m"
  puts %q{
                 _   _                       _
  ___  __ _ _ __| |_| |__   __ _ _   _  __ _| | _____
 / _ \/ _` | '__| __| '_ \ / _` | | | |/ _` | |/ / _ \
|  __/ (_| | |  | |_| | | | (_| | |_| | (_| |   <  __/
 \___|\__,_|_|   \__|_| |_|\__, |\__,_|\__,_|_|\_\___|
                              |_|           }.
  gsub(/^\n/, '') + "v#{Earthquake::VERSION}".rjust(10) + "\n\n"
  print "\e[0m"
end

require 'earthquake'
if command
  Earthquake.invoke(command, options)
else
  Earthquake.start(options)
end
